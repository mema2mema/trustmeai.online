<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invite Friends — TrustMe AI</title>
  <link rel="stylesheet" href="./styles/invite.css" />
</head>
<body>
  <header class="invite-header">
    <a href="./index.html#team" class="back-btn">← Back</a>
    <div class="title-wrap">
      <h1>Invite Friends</h1>
      <p class="subtitle">Share your invite link and earn rewards.</p>
    </div>
  </header>

  <main class="invite-grid">
    <section class="card qr-card">
      <h2>QR Code</h2>
      <div id="qrBox" class="qr-box"></div>
      <div class="hint">Scanning the QR opens your personal registration link.</div>
      <button id="btnDownload" class="btn">Download QR</button>
    </section>

    <section class="card link-card">
      <h2>Invite Link</h2>
      <div class="row">
        <input id="inviteLink" type="text" readonly />
        <button id="btnCopy" class="btn">Copy</button>
        <button id="btnShare" class="btn primary">Share</button>
      </div>

      <h2 style="margin-top: 24px;">Invitation Code</h2>
      <div class="row">
        <input id="inviteCode" type="text" />
        <button id="btnCopyCode" class="btn">Copy</button>
      </div>
      <p class="tip">
        Tip: You can change the code — your link and QR will update automatically.
      </p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    (function () {
      const codeInput = document.getElementById('inviteCode');
      const linkInput = document.getElementById('inviteLink');
      const qrBox = document.getElementById('qrBox');
      const btnCopy = document.getElementById('btnCopy');
      const btnCopyCode = document.getElementById('btnCopyCode');
      const btnShare = document.getElementById('btnShare');
      const btnDownload = document.getElementById('btnDownload');

      const BASE = (location.origin || '') + '/reg';
      const LS_KEY = 'trustmeai_invite_code';

      function getCode() { return (localStorage.getItem(LS_KEY) || 'TMI8K').trim(); }
      function setCode(v) { localStorage.setItem(LS_KEY, v); }
      function linkFor(code) { return BASE + '?ref=' + encodeURIComponent(code); }

      function render() {
        const code = getCode();
        codeInput.value = code;
        const url = linkFor(code);
        linkInput.value = url;
        qrBox.innerHTML = '';
        try {
          new QRCode(qrBox, { text: url, width: 240, height: 240, correctLevel: QRCode.CorrectLevel.M });
        } catch (err) {
          qrBox.textContent = 'QR error: ' + (err && err.message ? err.message : err);
        }
      }

      codeInput.addEventListener('input', () => { setCode(codeInput.value || 'TMI8K'); render(); });
      btnCopy.addEventListener('click', () => { linkInput.select(); document.execCommand('copy'); btnCopy.textContent='Copied!'; setTimeout(()=>btnCopy.textContent='Copy',1200); });
      btnCopyCode.addEventListener('click', () => { codeInput.select(); document.execCommand('copy'); btnCopyCode.textContent='Copied!'; setTimeout(()=>btnCopyCode.textContent='Copy',1200); });

      btnShare.addEventListener('click', async () => {
        const url = linkInput.value;
        try {
          if (navigator.share) { await navigator.share({ title: 'Join TrustMe AI', url }); }
          else { linkInput.select(); document.execCommand('copy'); alert('Link copied to clipboard'); }
        } catch (e) {}
      });

      btnDownload.addEventListener('click', () => {
        const img = qrBox.querySelector('img');
        const canvas = qrBox.querySelector('canvas');
        let dataUrl = '';
        if (img && img.src) dataUrl = img.src;
        if (!dataUrl && canvas) dataUrl = canvas.toDataURL('image/png');
        if (!dataUrl) return alert('QR not ready yet.');
        const a = document.createElement('a');
        a.href = dataUrl; a.download = 'trustmeai-invite.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      if (!localStorage.getItem(LS_KEY)) setCode('TMI8K');
      render();
    })();
  </script>
</body>
</html>
