<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Account — TrustMe AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="style.css" rel="stylesheet" />
  <style>
    :root {
      --bg:#0a0f1a; --ink:#e6f1ff; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --accent:#22c55e;
    }
    body { background:radial-gradient(1200px 800px at 70% -10%, rgba(34,197,94,.15), transparent), var(--bg); color:var(--ink); }
    .container{max-width:1100px;margin:40px auto;padding:0 16px}
    .grid{display:grid; gap:16px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:18px; padding:18px; backdrop-filter: blur(6px);}
    .muted{opacity:.8}
    .brand{font-weight:700; letter-spacing:.5px; color:var(--ink); text-decoration:none}
    .btn{padding:.6rem .9rem;border-radius:12px;border:1px solid var(--stroke);background:#1a2b22;color:#d7ffe6}
    .btn:hover{filter:brightness(1.1)}
    .btn-ghost{padding:.55rem .9rem;border-radius:12px;border:1px solid var(--stroke);background:transparent;color:var(--ink);text-decoration:none}
    .row{display:flex; align-items:center; gap:.6rem}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid var(--stroke); text-align:left}
    .stat{font-size:1.9rem; font-weight:700}
    .chip{font-size:.85rem;padding:.15rem .5rem;border:1px solid var(--stroke);border-radius:999px}
    .qr{width:160px; height:160px; border-radius:12px; border:1px solid var(--stroke); background:#0f172a; object-fit:contain}
    header.nav{position:sticky;top:0;background:rgba(6,10,20,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--stroke)}
    header.nav .wrap{max-width:1100px;margin:0 auto;padding:10px 16px}
    .spacer{flex:1}
    .tm-user{opacity:.85;margin-right:10px}
    input[type="number"], input[type="text"]{background:transparent;border:1px solid var(--stroke);padding:.55rem .7rem;border-radius:10px;color:var(--ink);width:120px}
    code.addr{user-select:all}
  </style>
</head>
<body>

  <!-- top bar -->
  <header class="nav">
    <div class="wrap row">
      <a class="brand" href="index.html">TrustMe AI</a>
      <div class="spacer"></div>
      <nav class="row" style="gap:.6rem">
        <a class="btn-ghost" href="index.html">Home</a>
        <a class="btn-ghost" href="strategy.html">Strategy</a>
        <a class="btn-ghost" href="assets.html">Assets</a>
      <a href="team.html">Team</a>
        <a class="btn-ghost" href="deposit.html">Deposit</a>
        <a class="btn-ghost" href="withdraw.html">Withdraw</a>
      </nav>
      <div class="spacer"></div>
      <div id="authArea" class="row"></div>
    </div>
  </header>

  <main class="container">
    <h1 class="row" style="gap:.8rem">
      Account
      <span id="userEmail" class="chip muted"></span>
    </h1>

    <!-- STAT CARDS -->
    <section class="grid g-3" style="margin-top:14px">
      <div class="card">
        <div class="muted">Available (USDT)</div>
        <div id="statAvail" class="stat">0.00</div>
      </div>
      <div class="card">
        <div class="muted">Locked (USDT)</div>
        <div id="statLocked" class="stat">0.00</div>
      </div>
      <div class="card">
        <div class="muted">Today’s Earnings</div>
        <div id="statEarn" class="stat">0.00</div>
      </div>
    </section>

    <!-- ACTIONS -->
    <section class="grid g-3" style="margin-top:18px">
      <div class="card">
        <h3 style="margin:0 0 8px">Deposit (USDT-TRON)</h3>
        <div class="row" style="justify-content:space-between">
          <button id="btnAddr" class="btn" type="button">Get Address + QR</button>
          <div class="row">
            <input id="topupAmt" type="number" min="10" step="1" placeholder="Amount" />
            <button id="btnTopup" class="btn" type="button" title="Demo credit">Top up (demo)</button>
          </div>
        </div>
        <div id="addrWrap" style="margin-top:12px; display:none" class="row">
          <img id="qr" class="qr" alt="QR"/>
          <div>
            <div class="muted">TRC20 Address</div>
            <code id="addr" class="addr"></code>
          </div>
        </div>
        <p class="muted" style="margin-top:10px">Note: “Top up (demo)” just increases your available balance for testing.</p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Quick Links</h3>
        <div class="row" style="flex-wrap:wrap; gap:.5rem">
          <a class="btn" href="strategy.html">Activate Plan</a>
          <a class="btn" href="withdraw.html">Withdraw</a>
          <a class="btn-ghost" href="assets.html">View Assets</a>
        </div>
        <p id="actMsg" class="muted" style="margin-top:10px"></p>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Session</h3>
        <div class="row">
          <button id="btnLogout" class="btn" type="button">Logout</button>
        </div>
        <p class="muted" style="margin-top:10px">Logs you out of this device.</p>
      </div>
    </section>

    <!-- POSITIONS -->
    <section class="card" style="margin-top:18px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">Open Positions</h3>
        <a class="btn-ghost" href="strategy.html">+ Activate new</a>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table>
          <thead>
            <tr><th>Tier</th><th>Amount (USDT)</th><th>Daily %</th><th>Opened</th></tr>
          </thead>
          <tbody id="posBody">
            <tr><td colspan="4" class="muted">No positions yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG ===
    const API = "http://localhost:8080"; // change to your deployed API when live

    // === NAVBAR AUTH (simple) ===
    async function drawAuthArea(){
      const area = document.getElementById('authArea'); if(!area) return;
      area.innerHTML = '';
      try{
        const me = await fetch(API+'/auth/me',{credentials:'include'}).then(r=>r.json());
        if(me.user){
          const span = document.createElement('span'); span.className='tm-user'; span.textContent = me.user.email;
          const out = document.createElement('button'); out.className='btn'; out.textContent='Logout';
          out.onclick = async()=>{ await fetch(API+'/auth/logout',{method:'POST',credentials:'include'}); location.href='login.html'; };
          area.appendChild(span); area.appendChild(out);
        }else{
          const a1=document.createElement('a'); a1.href='login.html'; a1.className='btn-ghost'; a1.textContent='Login';
          const a2=document.createElement('a'); a2.href='register.html'; a2.className='btn'; a2.textContent='Register';
          area.appendChild(a1); area.appendChild(a2);
        }
      }catch(e){ console.error(e); }
    }

    // === HELPERS ===
    const fmt = n => (Number(n||0)).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    const fromTs = ts => new Date(ts).toLocaleString();

    async function loadMe(){
      const r = await fetch(API+'/auth/me',{credentials:'include'}).then(r=>r.json());
      if(!r.user){ location.href='login.html?next=account.html'; return; }
      document.getElementById('userEmail').textContent = r.user.email;
      document.getElementById('statAvail').textContent = fmt(r.user.balance_available);
      document.getElementById('statLocked').textContent = fmt(r.user.balance_locked);

      // naive “today’s earnings” estimate from locked * average 1% (demo)
      const est = Number(r.user.balance_locked||0)*0.01;
      document.getElementById('statEarn').textContent = fmt(est);
    }

    async function loadPositions(){
      const data = await fetch(API+'/plans/positions',{credentials:'include'}).then(r=>r.json());
      const body = document.getElementById('posBody'); body.innerHTML='';
      if(!data.positions || data.positions.length===0){
        body.innerHTML = '<tr><td colspan="4" class="muted">No positions yet.</td></tr>'; return;
      }
      for(const p of data.positions){
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${p.tier}</td>
                        <td>${fmt(p.amount)}</td>
                        <td>${(Number(p.rate_daily)*100).toFixed(2)}%</td>
                        <td>${fromTs(p.created_at)}</td>`;
        body.appendChild(tr);
      }
    }

    async function getDeposit(){
      const res = await fetch(API+'/wallet/deposit-address',{credentials:'include'}).then(r=>r.json());
      document.getElementById('addr').textContent = res.address;
      document.getElementById('qr').src = res.qr;
      document.getElementById('addrWrap').style.display='flex';
    }

    async function topup(){
      const amt = Number(document.getElementById('topupAmt').value||0);
      if(!(amt>0)) return alert('Enter amount > 0');
      const r = await fetch(API+'/wallet/mock-credit',{
        method:'POST', headers:{'Content-Type':'application/json'},
        credentials:'include', body:JSON.stringify({amount:amt})
      }).then(r=>r.json());
      await loadMe();
      document.getElementById('actMsg').textContent = 'Balance updated. New available: '+fmt(r.balance_available);
    }

    // EVENTS
    document.getElementById('btnAddr').addEventListener('click', getDeposit);
    document.getElementById('btnTopup').addEventListener('click', topup);
    document.getElementById('btnLogout').addEventListener('click', async()=>{
      await fetch(API+'/auth/logout',{method:'POST',credentials:'include'});
      location.href='login.html';
    });

    // INIT
    drawAuthArea();
    loadMe();
    loadPositions();
  </script>
</body>
</html>
